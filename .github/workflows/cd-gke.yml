name: CI-CD to GKE

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  REPO_NAME: iris-repo
  IMAGE_NAME: iris-api
  IMAGE_URI: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/iris-repo/iris-api
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_LOCATION: ${{ secrets.GKE_LOCATION }}

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------- Authenticate to GCP with key (exam/simple path) --------
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      # -------- Configure Docker to use Artifact Registry --------
      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

      # -------- Build and push docker image --------
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_URI }}:${{ github.sha }}
            ${{ env.IMAGE_URI }}:latest

      # -------- Get GKE credentials for kubectl --------
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials "$GKE_CLUSTER" --region "$GKE_LOCATION" --project "$PROJECT_ID" || \
          gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_LOCATION" --project "$PROJECT_ID"

      # -------- Create namespace (idempotent) --------
      - name: Apply namespace
        run: kubectl apply -f k8s/namespace.yaml

      # -------- Apply manifests with a placeholder image, then set the new image tag --------
      - name: Apply Deployment & Service
        run: |
          # Replace placeholder image in-memory and apply
          sed "s|REPLACEME_IMAGE_URI|${IMAGE_URI}:${GITHUB_SHA}|g" k8s/deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/service.yaml

      # -------- Verify rollout --------
      - name: Wait for rollout
        run: kubectl -n iris rollout status deploy/iris-api --timeout=180s

      # -------- Show service external IP (if available) --------
      - name: Get Service External IP
        run: kubectl -n iris get svc iris-api-svc -o wide
