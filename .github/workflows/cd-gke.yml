name: CI/CD - IRIS API to GKE

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: iris-api

jobs:
  build-deploy:
    name: Build, Push, and Deploy to GKE
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # 1️⃣ Checkout the repo
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # 2️⃣ Authenticate to Google Cloud
      # ------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: "gke-gcloud-auth-plugin"

      # ------------------------------
      # 3️⃣ Configure Docker for Artifact Registry
      # ------------------------------
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      # ------------------------------
      # 4️⃣ Build and push Docker image
      # ------------------------------
      - name: Build and Push Docker image
        id: build
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.GCP_AR_REPO }}/${{ env.IMAGE_NAME }}"
          TAG=$(echo $GITHUB_SHA | cut -c1-7)
          docker build -t $IMAGE:$TAG -t $IMAGE:latest .
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest
          echo "image=$IMAGE:$TAG" >> $GITHUB_OUTPUT

      # ------------------------------
      # 5️⃣ Get GKE credentials
      # ------------------------------
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GCP_GKE_CLUSTER }}
          location: ${{ secrets.GCP_GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT }}

      # ------------------------------
      # 6️⃣ Deploy to Kubernetes
      # ------------------------------
      - name: Deploy to GKE
        run: |
          kubectl -n ${{ secrets.K8S_NAMESPACE }} set image deployment/iris-api iris-api-container=${{ steps.build.outputs.image }}
          kubectl -n ${{ secrets.K8S_NAMESPACE }} rollout status deployment/iris-api

      # ------------------------------
      # 7️⃣ (Optional) Verify health endpoint
      # ------------------------------
      - name: Verify Deployment Health
        run: |
          echo "Checking /health endpoint..."
          sleep 20
          EXTERNAL_IP=$(kubectl -n ${{ secrets.K8S_NAMESPACE }} get svc iris-api -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Service External IP: $EXTERNAL_IP"
          curl -f http://$EXTERNAL_IP/health

